<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restaurant Audit | Modern Interface</title>
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --error-color: #ef4444;
            --neutral-100: #f8fafc;
            --neutral-200: #e2e8f0;
            --neutral-300: #cbd5e1;
            --neutral-400: #94a3b8;
            --neutral-500: #64748b;
            --neutral-600: #475569;
            --neutral-700: #334155;
            --neutral-800: #1e293b;
            --neutral-900: #0f172a;
            --white: #ffffff;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1);
            --border-radius: 12px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--neutral-100);
            color: var(--neutral-800);
            line-height: 1.6;
        }

        /* Header */
        .header {
            background: var(--white);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--neutral-200);
            padding: 1rem 1.5rem;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow-sm);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .back-btn {
            background: var(--neutral-100);
            color: var(--neutral-600);
            border: 1px solid var(--neutral-200);
            padding: 0.75rem 1rem;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .back-btn:hover {
            background: var(--neutral-200);
            transform: translateY(-1px);
        }

        .restaurant-info h1 {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--neutral-800);
        }

        .restaurant-info p {
            font-size: 0.875rem;
            color: var(--neutral-500);
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .save-progress-btn {
            background: var(--neutral-100);
            color: var(--neutral-600);
            border: 1px solid var(--neutral-200);
            padding: 0.75rem 1rem;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }

        .save-progress-btn:hover {
            background: var(--warning-color);
            color: var(--white);
            border-color: var(--warning-color);
        }

        .submit-btn {
            background: var(--primary-gradient);
            color: var(--white);
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow-md);
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .submit-btn:disabled {
            background: var(--neutral-300);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Main Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1.5rem;
        }

        /* Status Cards */
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .status-card {
            background: var(--white);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--neutral-200);
            transition: var(--transition);
        }

        .status-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .status-card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .status-card h3 {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--neutral-500);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .status-icon {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            color: var(--white);
        }

        .status-icon.location { background: var(--success-color); }
        .status-icon.progress { background: var(--primary-color); }
        .status-icon.score { background: var(--warning-color); }
        .status-icon.time { background: var(--secondary-color); }

        .status-value {
            font-size: 2rem;
            font-weight: 800;
            color: var(--neutral-800);
            margin-bottom: 0.5rem;
        }

        .status-label {
            font-size: 0.875rem;
            color: var(--neutral-500);
        }

        /* Progress Ring */
        .progress-ring {
            position: relative;
            display: inline-block;
        }

        .progress-ring svg {
            transform: rotate(-90deg);
        }

        .progress-ring-circle {
            transition: stroke-dashoffset 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .progress-ring-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--neutral-800);
        }

        /* Main Layout */
        .main-layout {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2rem;
            align-items: start;
        }

        .categories-section {
            background: var(--white);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--neutral-200);
        }

        .categories-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .categories-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--neutral-800);
        }

        .filter-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .filter-btn {
            padding: 0.5rem 1rem;
            border: 1px solid var(--neutral-200);
            background: var(--white);
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .filter-btn.active {
            background: var(--primary-color);
            color: var(--white);
            border-color: var(--primary-color);
        }

        /* Category Grid */
        .category-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
        }

        .category-card {
            background: var(--white);
            border: 2px solid var(--neutral-200);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            cursor: pointer;
            transition: var(--transition);
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .category-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--neutral-200);
            transition: var(--transition);
        }

        .category-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary-color);
        }

        .category-card:hover::before {
            background: var(--primary-gradient);
        }

        .category-card.completed {
            border-color: var(--success-color);
            background: linear-gradient(135deg, #ecfdf5 0%, #f0fdf4 100%);
        }

        .category-card.completed::before {
            background: var(--success-color);
        }

        .category-card.in-progress {
            border-color: var(--warning-color);
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
        }

        .category-card.in-progress::before {
            background: var(--warning-color);
        }

        .category-icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            display: block;
        }

        .category-name {
            font-weight: 600;
            color: var(--neutral-800);
            margin-bottom: 0.5rem;
        }

        .category-progress {
            font-size: 0.75rem;
            color: var(--neutral-500);
            margin-bottom: 1rem;
        }

        .category-status {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .category-status.pending {
            background: var(--neutral-100);
            color: var(--neutral-600);
        }

        .category-status.in-progress {
            background: #fef3c7;
            color: #92400e;
        }

        .category-status.completed {
            background: #d1fae5;
            color: #065f46;
        }

        /* Sidebar */
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .sidebar-card {
            background: var(--white);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--neutral-200);
        }

        .sidebar-card h3 {
            font-size: 1rem;
            font-weight: 700;
            color: var(--neutral-800);
            margin-bottom: 1rem;
        }

        .overall-comment textarea {
            width: 100%;
            min-height: 120px;
            border: 2px solid var(--neutral-200);
            border-radius: 8px;
            padding: 1rem;
            font-size: 0.875rem;
            resize: vertical;
            transition: var(--transition);
        }

        .overall-comment textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* Audit Timeline */
        .audit-timeline {
            position: relative;
        }

        .timeline-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
            position: relative;
        }

        .timeline-item:last-child {
            margin-bottom: 0;
        }

        .timeline-item::after {
            content: '';
            position: absolute;
            left: 1rem;
            top: 2rem;
            width: 2px;
            height: calc(100% + 1rem);
            background: var(--neutral-200);
        }

        .timeline-item:last-child::after {
            display: none;
        }

        .timeline-dot {
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
            position: relative;
            z-index: 1;
        }

        .timeline-dot.completed {
            background: var(--success-color);
            color: var(--white);
        }

        .timeline-dot.current {
            background: var(--primary-color);
            color: var(--white);
        }

        .timeline-dot.pending {
            background: var(--neutral-200);
            color: var(--neutral-500);
        }

        .timeline-content {
            flex: 1;
        }

        .timeline-title {
            font-weight: 600;
            color: var(--neutral-800);
            font-size: 0.875rem;
        }

        .timeline-subtitle {
            font-size: 0.75rem;
            color: var(--neutral-500);
        }

        /* Chat Modal */
        .chat-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            transition: var(--transition);
        }

        .chat-modal.active {
            opacity: 1;
        }

        .chat-container {
            width: 90%;
            max-width: 600px;
            height: 85%;
            max-height: 800px;
            background: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-xl);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transform: scale(0.95);
            transition: var(--transition);
        }

        .chat-modal.active .chat-container {
            transform: scale(1);
        }

        .chat-header {
            background: var(--primary-gradient);
            color: var(--white);
            padding: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-title {
            font-size: 1.25rem;
            font-weight: 700;
        }

        .chat-subtitle {
            font-size: 0.875rem;
            opacity: 0.9;
            margin-top: 0.25rem;
        }

        .close-chat {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: var(--white);
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.25rem;
            transition: var(--transition);
        }

        .close-chat:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }

        .chat-progress {
            background: var(--neutral-100);
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--neutral-200);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .progress-bar {
            flex: 1;
            height: 6px;
            background: var(--neutral-200);
            border-radius: 3px;
            margin: 0 1rem;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--success-color);
            border-radius: 3px;
            transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .chat-messages {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .message {
            max-width: 85%;
            padding: 1rem 1.25rem;
            border-radius: 18px;
            line-height: 1.5;
            position: relative;
        }

        .bot-message {
            background: var(--neutral-100);
            color: var(--neutral-800);
            align-self: flex-start;
            border-bottom-left-radius: 6px;
        }

        .user-message {
            background: var(--primary-gradient);
            color: var(--white);
            align-self: flex-end;
            border-bottom-right-radius: 6px;
        }

        .typing-indicator {
            align-self: flex-start;
            background: var(--neutral-100);
            padding: 1rem 1.25rem;
            border-radius: 18px;
            display: flex;
            gap: 0.25rem;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--neutral-400);
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }

        .chat-input {
            padding: 1.5rem;
            border-top: 1px solid var(--neutral-200);
            background: var(--neutral-50);
        }

        .answer-options {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .answer-group {
            display: grid;
            gap: 0.75rem;
        }

        .primary-answers {
            grid-template-columns: repeat(2, 1fr);
        }

        .rating-answers {
            grid-template-columns: repeat(5, 1fr);
        }

        .answer-btn {
            background: var(--white);
            color: var(--neutral-700);
            border: 2px solid var(--neutral-200);
            padding: 1rem;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .answer-btn:hover {
            border-color: var(--primary-color);
            background: var(--primary-color);
            color: var(--white);
            transform: translateY(-2px);
        }

        .answer-btn.selected {
            border-color: var(--success-color);
            background: var(--success-color);
            color: var(--white);
        }

        .follow-up-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .follow-up-textarea {
            width: 100%;
            min-height: 80px;
            border: 2px solid var(--neutral-200);
            border-radius: 12px;
            padding: 1rem;
            resize: vertical;
            transition: var(--transition);
        }

        .follow-up-textarea:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .follow-up-actions {
            display: flex;
            gap: 0.75rem;
        }

        .skip-btn {
            background: transparent;
            color: var(--neutral-500);
            border: 2px solid transparent;
        }

        .skip-btn:hover {
            background: var(--neutral-100);
            border-color: var(--neutral-200);
        }

        /* Loading States */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 3rem;
            color: var(--neutral-500);
        }

        .spinner {
            width: 2rem;
            height: 2rem;
            border: 3px solid var(--neutral-200);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: var(--error-color);
            padding: 1rem;
            border-radius: var(--border-radius);
            text-align: center;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
            
            .header-content {
                padding: 0 1rem;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            .status-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
            }
            
            .category-grid {
                grid-template-columns: 1fr;
            }
            
            .header-actions {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .chat-container {
                width: 95%;
                height: 95%;
            }
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.6s ease-out;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .slide-up {
            animation: slideUp 0.4s ease-out;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <div class="header-left">
                <button class="back-btn" onclick="goBack()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="m12 19-7-7 7-7"/>
                        <path d="M19 12H5"/>
                    </svg>
                    Back
                </button>
                <div class="restaurant-info">
                    <h1 id="restaurant-name">Loading...</h1>
                    <p id="restaurant-address">Fetching details...</p>
                </div>
            </div>
            <div class="header-actions">
                <button class="save-progress-btn" id="save-progress-btn" onclick="saveProgress()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                        <polyline points="17,21 17,13 7,13 7,21"/>
                        <polyline points="7,3 7,8 15,8"/>
                    </svg>
                    Save Progress
                </button>
                <button class="submit-btn" id="submit-btn" onclick="submitAudit()" disabled>
                    Submit Audit
                </button>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Loading State -->
        <div id="loading" class="loading">
            <div class="spinner"></div>
            Loading audit checklist...
        </div>

        <!-- Error State -->
        <div id="error" class="error" style="display: none;"></div>

        <!-- Main Interface -->
        <div id="audit-interface" style="display: none;">
            <!-- Status Cards -->
            <div class="status-grid">
                <div class="status-card fade-in">
                    <div class="status-card-header">
                        <h3>Location Status</h3>
                        <div class="status-icon location" id="location-icon">üìç</div>
                    </div>
                    <div class="status-value" id="location-status">Checking...</div>
                    <div class="status-label" id="location-message">Validating your location</div>
                </div>

                <div class="status-card fade-in">
                    <div class="status-card-header">
                        <h3>Progress</h3>
                        <div class="status-icon progress">üìä</div>
                    </div>
                    <div class="status-value">
                        <div class="progress-ring">
                            <svg width="60" height="60" viewBox="0 0 60 60">
                                <circle cx="30" cy="30" r="25" fill="none" stroke="#e2e8f0" stroke-width="4"/>
                                <circle id="progress-circle" cx="30" cy="30" r="25" fill="none" stroke="#667eea" stroke-width="4" 
                                        stroke-linecap="round" stroke-dasharray="157" stroke-dashoffset="157"/>
                            </svg>
                            <div class="progress-ring-text" id="completion-percentage">0%</div>
                        </div>
                    </div>
                    <div class="status-label" id="completion-status">0/0 questions completed</div>
                </div>

                <div class="status-card fade-in">
                    <div class="status-card-header">
                        <h3>Audit Score</h3>
                        <div class="status-icon score" id="score-icon">‚≠ê</div>
                    </div>
                    <div class="status-value" id="audit-score">0</div>
                    <div class="status-label" id="score-label">Average rating</div>
                </div>

                <div class="status-card fade-in">
                    <div class="status-card-header">
                        <h3>Time Elapsed</h3>
                        <div class="status-icon time">‚è±Ô∏è</div>
                    </div>
                    <div class="status-value" id="time-elapsed">00:00</div>
                    <div class="status-label">Started at <span id="start-time">--:--</span></div>
                </div>
            </div>

            <!-- Main Layout -->
            <div class="main-layout">
                <!-- Categories Section -->
                <div class="categories-section fade-in">
                    <div class="categories-header">
                        <h2 class="categories-title">Audit Categories</h2>
                        <div class="filter-buttons">
                            <button class="filter-btn active" onclick="filterCategories('all')">All</button>
                            <button class="filter-btn" onclick="filterCategories('pending')">Pending</button>
                            <button class="filter-btn" onclick="filterCategories('in-progress')">In Progress</button>
                            <button class="filter-btn" onclick="filterCategories('completed')">Completed</button>
                        </div>
                    </div>
                    <div class="category-grid" id="category-grid"></div>
                </div>

                <!-- Sidebar -->
                <div class="sidebar">
                    <!-- Overall Comments -->
                    <div class="sidebar-card overall-comment fade-in">
                        <h3>Overall Comments</h3>
                        <textarea id="overall-comment" placeholder="Add any overall observations, recommendations, or notes about this audit..."></textarea>
                    </div>

                    <!-- Audit Timeline -->
                    <div class="sidebar-card audit-timeline fade-in">
                        <h3>Audit Progress</h3>
                        <div id="timeline-container"></div>
                    </div>

                    <!-- Quick Stats -->
                    <div class="sidebar-card fade-in">
                        <h3>Quick Stats</h3>
                        <div class="stats-grid">
                            <div class="stat-item">
                                <div class="stat-value" id="total-questions">0</div>
                                <div class="stat-label">Total Questions</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="answered-questions">0</div>
                                <div class="stat-label">Answered</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="categories-completed">0</div>
                                <div class="stat-label">Categories Done</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="images-uploaded">0</div>
                                <div class="stat-label">Images</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Chat Modal -->
    <div class="chat-modal" id="chat-modal">
        <div class="chat-container">
            <div class="chat-header">
                <div>
                    <div class="chat-title" id="chat-title">Category Audit</div>
                    <div class="chat-subtitle" id="chat-subtitle">Answer questions to complete this section</div>
                </div>
                <button class="close-chat" id="close-chat">&times;</button>
            </div>

            <div class="chat-progress">
                <span id="question-counter">1 of 5</span>
                <div class="progress-bar">
                    <div class="progress-fill" id="chat-progress-fill" style="width: 20%"></div>
                </div>
                <span id="category-completion">20% Complete</span>
            </div>

            <div class="chat-messages" id="chat-messages"></div>

            <div class="chat-input" id="chat-input">
                <div class="answer-options" id="answer-options"></div>
            </div>
        </div>
    </div>

    <script>

     console.log("üöÄ audit-form.js script loaded");

        // Global State Management
        let currentRestaurant = null;
        let auditData = {
            categories: [],
            answers: {},
            startTime: new Date(),
            lastSaved: null,
            isAutoSaveEnabled: true
        };
        let totalQuestions = 0;
        let auditTimer = null;
        
        // Chat Modal State
        let currentCategory = null;
        let questionQueue = [];
        let followUpQueue = [];
        let currentQuestion = null;
        let currentFilter = 'all';

        // Initialize the application
        document.addEventListener('DOMContentLoaded', initializeAuditForm);
// Replace the initializeAuditForm function in your audit-form.js

async function initializeAuditForm() {
    try {
        console.log("‚ö° initializeAuditForm triggered");

        const urlParams = new URLSearchParams(window.location.search);
        document.getElementById('close-chat').addEventListener('click', closeChat);

        // Check if this is a daily audit
        const isDailyAudit = urlParams.get('daily_audit') === '1';
        const progressId = urlParams.get('progress_id');
        
        let restaurantId = null;
        
        if (isDailyAudit && progressId) {
            // For daily audit, get restaurant from progress record
            console.log("üìÖ Daily audit detected, progress ID:", progressId);
            
            // Get daily audit data from sessionStorage
            const dailyAuditData = sessionStorage.getItem('dailyAuditData');
            if (dailyAuditData) {
                const parsedData = JSON.parse(dailyAuditData);
                restaurantId = parsedData.restaurant;
                
                // Set current restaurant for display
                if (parsedData.restaurant) {
                    // Get restaurant details
                    const restaurantResponse = await fetch('/api/method/frappe.client.get', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            doctype: 'Restaurant',
                            name: parsedData.restaurant
                        })
                    });
                    
                    if (restaurantResponse.ok) {
                        const restaurantResult = await restaurantResponse.json();
                        if (restaurantResult.message) {
                            currentRestaurant = restaurantResult.message;
                            updateRestaurantInfo();
                        }
                    }
                }
                
                console.log("üìã Daily audit restaurant:", restaurantId);
            } else {
                throw new Error('Daily audit data not found. Please start the audit from the dashboard.');
            }
        } else {
            // Regular audit - get restaurant from URL parameter
            restaurantId = urlParams.get('restaurant');
            if (!restaurantId) {
                throw new Error('No restaurant selected.');
            }
            
            // Load stored restaurant data for regular audit
            const storedRestaurant = sessionStorage.getItem('selectedRestaurant');
            if (storedRestaurant) {
                currentRestaurant = JSON.parse(storedRestaurant);
                updateRestaurantInfo();
            }
        }

        if (!restaurantId) {
            throw new Error('No restaurant available for audit.');
        }

        // Start the audit timer
        startAuditTimer();

        // Load any saved progress (only for regular audits)
        if (!isDailyAudit) {
            await loadSavedProgress(restaurantId);
        }

        // Check user location
        await checkUserLocation(restaurantId);

        // Load checklist template
        if (isDailyAudit) {
            await loadDailyAuditQuestions(progressId);
        } else {
            await loadChecklistTemplate(restaurantId);
        }

        // Setup auto-save
        setupAutoSave();

    } catch (error) {
        console.error('Initialization error:', error);
        showError(error.message);
    }
}

// New function to load daily audit questions
async function loadDailyAuditQuestions(progressId) {
    try {
        console.log("üì• Loading daily audit questions for progress:", progressId);

        // Get daily audit data from sessionStorage
        const dailyAuditData = sessionStorage.getItem('dailyAuditData');
        if (!dailyAuditData) {
            throw new Error('Daily audit data not found');
        }

        const parsedData = JSON.parse(dailyAuditData);
        
        // Process template data similar to regular audit
        const icons = ["üßº", "üç≥", "üòä", "üî•", "üìã", "üì¶", "üè™", "üßΩ", "üë•", "üì±"];
        auditData.categories = [];
        
        if (parsedData.questions_data && parsedData.questions_data.length > 0) {
            parsedData.questions_data.forEach((categoryData, index) => {
                auditData.categories.push({
                    id: categoryData.category.name,
                    name: categoryData.category.category_name,
                    icon: icons[index % icons.length],
                    questions: categoryData.questions.map(q => ({
                        id: q.name,
                        text: q.question_text,
                        type: q.answer_type,
                        options: q.options || [],
                        is_mandatory: q.is_mandatory,
                        allow_image_upload: q.allow_image_upload,
                        comment: q.question_comment
                    })),
                    completed: false,
                    progress: 0
                });
            });
        }

        totalQuestions = auditData.categories.reduce((acc, cat) => acc + cat.questions.length, 0);

        console.log("üìä Daily audit categories loaded:", auditData.categories.length);
        console.log("üìä Total questions:", totalQuestions);

        // Update UI
        document.getElementById('loading').style.display = 'none';
        document.getElementById('audit-interface').style.display = 'block';

        renderCategoryGrid();
        updateDashboard();
        updateTimeline();
        updateQuickStats();

    } catch (error) {
        console.error('‚ùå Error loading daily audit questions:', error);
        showError(error.message);
    }
}
        function updateRestaurantInfo() {
            if (currentRestaurant) {
                document.getElementById('restaurant-name').textContent = currentRestaurant.restaurant_name;
                document.getElementById('restaurant-address').textContent = currentRestaurant.address || 'Address not specified';
            }
        }

        function startAuditTimer() {
            const startTimeEl = document.getElementById('start-time');
            const timeElapsedEl = document.getElementById('time-elapsed');
            
            startTimeEl.textContent = auditData.startTime.toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });

            auditTimer = setInterval(() => {
                const elapsed = new Date() - auditData.startTime;
                const minutes = Math.floor(elapsed / 60000);
                const seconds = Math.floor((elapsed % 60000) / 1000);
                timeElapsedEl.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }

        async function loadSavedProgress(restaurantId) {
            try {
                const savedData = localStorage.getItem(`audit_progress_${restaurantId}`);
                if (savedData) {
                    const parsed = JSON.parse(savedData);
                    auditData.answers = parsed.answers || {};
                    auditData.lastSaved = new Date(parsed.timestamp);
                    
                    // Show restoration notification
                    showNotification('Progress restored from ' + auditData.lastSaved.toLocaleTimeString(), 'success');
                }
            } catch (error) {
                console.error('Error loading saved progress:', error);
            }
        }

        async function saveProgress() {
            try {
                const restaurantId = currentRestaurant?.name;
                if (!restaurantId) return;

                const progressData = {
                    answers: auditData.answers,
                    timestamp: new Date().toISOString(),
                    restaurant: restaurantId
                };

                localStorage.setItem(`audit_progress_${restaurantId}`, JSON.stringify(progressData));
                auditData.lastSaved = new Date();
                
                // Update save button
                const saveBtn = document.getElementById('save-progress-btn');
                const originalText = saveBtn.innerHTML;
                saveBtn.innerHTML = '‚úì Saved';
                saveBtn.style.background = 'var(--success-color)';
                saveBtn.style.color = 'var(--white)';
                
                setTimeout(() => {
                    saveBtn.innerHTML = originalText;
                    saveBtn.style.background = '';
                    saveBtn.style.color = '';
                }, 2000);

                showNotification('Progress saved successfully', 'success');
            } catch (error) {
                console.error('Error saving progress:', error);
                showNotification('Failed to save progress', 'error');
            }
        }

        function setupAutoSave() {
            // Auto-save every 30 seconds
            setInterval(() => {
                if (auditData.isAutoSaveEnabled && Object.keys(auditData.answers).length > 0) {
                    saveProgress();
                }
            }, 30000);
        }

        async function checkUserLocation(restaurantId) {
            const locationIcon = document.getElementById('location-icon');
            const locationStatus = document.getElementById('location-status');
            const locationMessage = document.getElementById('location-message');

            try {
                locationStatus.textContent = 'Checking...';
                locationMessage.textContent = 'Getting your location';

                const position = await getCurrentPosition();
                const { latitude, longitude } = position.coords;

                const response = await fetch('/api/method/restaurant_audit.api.audit_api.validate_location', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        restaurant_id: restaurantId,
                        user_latitude: latitude,
                        user_longitude: longitude
                    })
                });

                if (!response.ok) throw new Error(`Server error: ${response.status}`);

                const result = await response.json();
                if (result?.message?.success) {
                    const validation = result.message;
                    if (validation.is_within_range) {
                        locationIcon.textContent = '‚úì';
                        locationIcon.style.background = 'var(--success-color)';
                        locationStatus.textContent = 'Verified';
                        locationMessage.textContent = `Within ${validation.allowed_radius}m radius`;
                    } else {
                        throw new Error(validation.message);
                    }
                } else {
                    throw new Error(result?.message?.message || 'Location validation failed');
                }
            } catch (error) {
                console.error('Location check failed:', error);
                locationIcon.textContent = '‚úó';
                locationIcon.style.background = 'var(--error-color)';
                locationStatus.textContent = 'Failed';
                locationMessage.textContent = error.message || 'Location check failed';
                
                showNotification('Location verification failed. You may not be able to submit the audit.', 'warning');
            }
        }
function getCurrentPosition() {
    return new Promise((resolve, reject) => {
        if (!navigator.geolocation) {
            return reject(new Error("Geolocation is not supported by this browser"));
        }
        navigator.geolocation.getCurrentPosition(resolve, reject);
    });
}

        async function loadChecklistTemplate(restaurantId) {
    try {
        console.log("üì• Fetching checklist for restaurant:", restaurantId);

        const response = await fetch('/api/method/restaurant_audit.api.audit_api.get_checklist_template', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ restaurant_id: restaurantId })
        });

        console.log("üîé Response object:", response);

        if (!response.ok) {
            throw new Error(`Server error: ${response.status}`);
        }

        // Read raw text first
        const text = await response.text();
        console.log("üìÑ Raw response text:", text);

        // Try parsing JSON
        let result;
        try {
            result = JSON.parse(text);
        } catch (err) {
            throw new Error("Response was not valid JSON");
        }
console.log("üêû Full API result:", result);
console.log("üêû result.message:", result.message);

        if (!result.message?.success) {
            throw new Error(result.message?.message || 'Failed to load checklist');
        }

        // Process template data
        const icons = ["üßº", "üç≥", "üòä", "üî•", "üìã", "üì¶", "üè™", "üßΩ", "üë•", "üì±"];
        auditData.categories = result.message.templates.flatMap((template, tIndex) =>
            template.categories.map((cat, cIndex) => ({
                id: cat.id,
                name: cat.name,
                icon: icons[(tIndex + cIndex) % icons.length],
                questions: cat.questions.map(q => ({
                    id: q.id,
                    text: q.text,
                    type: q.answer_type,
                    options: q.options || [],
                    is_mandatory: q.is_mandatory,
                    allow_image_upload: q.allow_image_upload,
                    comment: q.comment
                })),
                completed: false,
                progress: 0
            }))
        );

        totalQuestions = auditData.categories.reduce((acc, cat) => acc + cat.questions.length, 0);

        // Update UI
        document.getElementById('loading').style.display = 'none';
        document.getElementById('audit-interface').style.display = 'block';

        renderCategoryGrid();
        updateDashboard();
        updateTimeline();
        updateQuickStats();

    } catch (error) {
        console.error('‚ùå Error loading checklist:', error);
        showError(error.message);
    }
}

        function renderCategoryGrid() {
            const grid = document.getElementById('category-grid');
            grid.innerHTML = '';

            auditData.categories.forEach((cat, index) => {
                // Calculate progress
                const answeredQuestions = cat.questions.filter(q => auditData.answers[q.id]).length;
                const progress = cat.questions.length > 0 ? Math.round((answeredQuestions / cat.questions.length) * 100) : 0;
                
                // Determine status
                let status = 'pending';
                let statusClass = 'pending';
                
                if (progress === 100) {
                    status = 'completed';
                    statusClass = 'completed';
                    cat.completed = true;
                } else if (progress > 0) {
                    status = 'in-progress';
                    statusClass = 'in-progress';
                }

                cat.progress = progress;
                cat.status = status;

                const card = document.createElement('div');
                card.className = `category-card ${statusClass} slide-up`;
                card.style.animationDelay = `${index * 0.1}s`;
                card.dataset.categoryId = cat.id;
                card.dataset.status = status;

                card.innerHTML = `
                    <div class="category-icon">${cat.icon}</div>
                    <div class="category-name">${cat.name}</div>
                    <div class="category-progress">${answeredQuestions}/${cat.questions.length} questions</div>
                    <div class="category-status ${statusClass}">${status.replace('-', ' ')}</div>
                `;

                card.addEventListener('click', () => openChat(cat.id));
                grid.appendChild(card);
            });

            applyCurrentFilter();
        }

        function filterCategories(filter) {
            currentFilter = filter;
            
            // Update filter buttons
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            applyCurrentFilter();
        }

        function applyCurrentFilter() {
            const cards = document.querySelectorAll('.category-card');
            
            cards.forEach(card => {
                const status = card.dataset.status;
                const shouldShow = currentFilter === 'all' || status === currentFilter;
                
                card.style.display = shouldShow ? 'block' : 'none';
            });
        }

        function updateDashboard() {
            const answeredCount = Object.keys(auditData.answers).length;
            const completion = totalQuestions > 0 ? Math.round((answeredCount / totalQuestions) * 100) : 0;

            // Update progress circle
            const progressCircle = document.getElementById('progress-circle');
            const circumference = 2 * Math.PI * 25;
            const offset = circumference - (completion / 100) * circumference;
            progressCircle.style.strokeDashoffset = offset;

            // Update text
            document.getElementById('completion-percentage').textContent = `${completion}%`;
            document.getElementById('completion-status').textContent = `${answeredCount}/${totalQuestions} questions completed`;

            // Calculate average score
            let totalScore = 0;
            let scoredAnswers = 0;
            
            Object.values(auditData.answers).forEach(answer => {
                if (answer.score !== undefined) {
                    totalScore += answer.score;
                    scoredAnswers++;
                }
            });

            const averageScore = scoredAnswers > 0 ? (totalScore / scoredAnswers).toFixed(1) : '0';
            document.getElementById('audit-score').textContent = averageScore;
            document.getElementById('score-label').textContent = `Average rating (${scoredAnswers} responses)`;

            // Update score icon color
            const scoreIcon = document.getElementById('score-icon');
            if (averageScore >= 4) {
                scoreIcon.style.background = 'var(--success-color)';
            } else if (averageScore >= 3) {
                scoreIcon.style.background = 'var(--warning-color)';
            } else {
                scoreIcon.style.background = 'var(--error-color)';
            }

            // Enable submit button if all questions answered
            const submitBtn = document.getElementById('submit-btn');
            submitBtn.disabled = completion < 100;
        }

        function updateTimeline() {
            const container = document.getElementById('timeline-container');
            container.innerHTML = '';

            auditData.categories.forEach((cat, index) => {
                const answeredQuestions = cat.questions.filter(q => auditData.answers[q.id]).length;
                const isCompleted = answeredQuestions === cat.questions.length;
                const hasAnswers = answeredQuestions > 0;

                const item = document.createElement('div');
                item.className = 'timeline-item';

                let dotClass = 'pending';
                if (isCompleted) dotClass = 'completed';
                else if (hasAnswers) dotClass = 'current';

                item.innerHTML = `
                    <div class="timeline-dot ${dotClass}">${index + 1}</div>
                    <div class="timeline-content">
                        <div class="timeline-title">${cat.name}</div>
                        <div class="timeline-subtitle">${answeredQuestions}/${cat.questions.length} completed</div>
                    </div>
                `;

                container.appendChild(item);
            });
        }

        function updateQuickStats() {
            const answeredCount = Object.keys(auditData.answers).length;
            const completedCategories = auditData.categories.filter(cat => cat.completed).length;
            const imagesCount = Object.values(auditData.answers).filter(answer => answer.image_data).length;

            document.getElementById('total-questions').textContent = totalQuestions;
            document.getElementById('answered-questions').textContent = answeredCount;
            document.getElementById('categories-completed').textContent = completedCategories;
            document.getElementById('images-uploaded').textContent = imagesCount;
        }

        // Chat Modal Functions
        function openChat(categoryId) {
            currentCategory = auditData.categories.find(c => c.id === categoryId);
            if (!currentCategory) return;

            // Restore progress: filter out already answered questions
            const answeredQuestionIds = Object.keys(auditData.answers);
            questionQueue = currentCategory.questions.filter(question => 
                !answeredQuestionIds.includes(question.id.toString()) && 
                !answeredQuestionIds.includes(question.id)
            );
            followUpQueue = [];

            // Setup modal
            document.getElementById('chat-title').textContent = currentCategory.name;
            const answeredCount = currentCategory.questions.length - questionQueue.length;
            const totalCount = currentCategory.questions.length;
            document.getElementById('chat-subtitle').textContent = 
                `${answeredCount}/${totalCount} questions completed (${questionQueue.length} remaining)`;
            document.getElementById('chat-messages').innerHTML = '';

            // Show modal
            const modal = document.getElementById('chat-modal');
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('active'), 10);

            // Show progress restoration message if there are answered questions
            if (answeredCount > 0) {
                addMessage(`üìã Resuming from question ${answeredCount + 1} of ${totalCount} (${answeredCount} already completed)`, "bot");
                setTimeout(() => {
                    processNextInQueue();
                }, 1500);
            } else {
                // Start first question immediately if no progress
                processNextInQueue();
            }
        }

        function closeChat() {
            // Save current progress before closing
            if (auditData.isAutoSaveEnabled) {
                saveProgress();
            }
            
            const modal = document.getElementById('chat-modal');
            modal.classList.remove('active');
            
            setTimeout(() => {
                modal.style.display = 'none';
                
                // Update UI
                renderCategoryGrid();
                updateDashboard();
                updateTimeline();
                updateQuickStats();
            }, 300);
        }

        function processNextInQueue() {
            updateChatProgress();

            if (followUpQueue.length > 0) {
                const followUp = followUpQueue.shift();
                askFollowUpQuestion(followUp);
            } else if (questionQueue.length > 0) {
                const question = questionQueue.shift();
                currentQuestion = question;
                askMainQuestion(question);
            } else {
                // Category completed
                addMessage("üéâ Section completed! Great work!", "bot");
                setTimeout(closeChat, 2000);
            }
        }

        function updateChatProgress() {
            const totalQuestions = currentCategory.questions.length;
            const remainingQuestions = questionQueue.length;
            const answeredQuestions = totalQuestions - remainingQuestions;
            const currentQuestionIndex = answeredQuestions; // Current question is the next one to answer
            const progress = Math.round((answeredQuestions / totalQuestions) * 100);

            document.getElementById('question-counter').textContent = `${currentQuestionIndex + 1} of ${totalQuestions}`;
            document.getElementById('chat-progress-fill').style.width = `${progress}%`;
            document.getElementById('category-completion').textContent = `${progress}% Complete`;
        }

        function askMainQuestion(question) {
            const indicator = showTypingIndicator();
            
            setTimeout(() => {
                indicator.remove();
                
                let questionHTML = `<strong>${question.text}</strong>`;
                if (question.comment) {
                    questionHTML += `<br><br><em>üí° ${question.comment}</em>`;
                }

                // Add multiple choice options if available
                if (question.options && question.options.length > 0) {
                    questionHTML += '<br><br><strong>Additional options:</strong><br>';
                    const optionsContainer = document.createElement('div');
                    optionsContainer.className = 'options-container';
                    
                    question.options.forEach(option => {
                        const label = document.createElement('label');
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.value = option.trim();
                        
                        label.appendChild(checkbox);
                        label.appendChild(document.createTextNode(' ' + option.trim()));
                        optionsContainer.appendChild(label);
                    });
                    
                    // Store for later retrieval
                    currentQuestion.optionsContainer = optionsContainer;
                }

                addMessage(questionHTML, "bot", `question-${question.id}`);
                renderAnswerOptions(question);
            }, 800);
        }

        function renderAnswerOptions(question) {
            const container = document.getElementById('answer-options');
            container.innerHTML = '';

            const answerGroup = document.createElement('div');
            answerGroup.className = 'answer-group';

            let options = [];
            
            if (question.type === 'Rating') {
                answerGroup.classList.add('rating-answers');
                options = Array.from({length: 5}, (_, i) => ({
                    text: '‚≠ê'.repeat(i + 1),
                    score: i + 1,
                    value: i + 1
                }));
            } else if (question.type === 'Yes/No') {
                answerGroup.classList.add('primary-answers');
                options = [
                    { text: '‚úÖ Yes', score: 5, value: 'Yes' },
                    { text: '‚ùå No', score: 1, value: 'No' }
                ];
            } else if (question.type === 'True/False') {
                answerGroup.classList.add('primary-answers');
                options = [
                    { text: '‚úÖ True', score: 5, value: 'True' },
                    { text: '‚ùå False', score: 1, value: 'False' }
                ];
            }
            else if (question.type === 'Text') {
                // ADD THIS BLOCK FOR TEXT QUESTIONS
                container.innerHTML = `
                    <div class="follow-up-container">
                        <textarea id="text-answer-input" class="follow-up-textarea" placeholder="Type your answer here..."></textarea>
                        <div class="follow-up-actions">
                            <button class="answer-btn" onclick="handleTextAnswer(currentQuestion)">Submit Answer</button>
                        </div>
                    </div>
                `;
                return; // Exit the function since we've set the HTML
            }

            options.forEach(option => {
                const btn = document.createElement('button');
                btn.className = 'answer-btn';
                btn.innerHTML = option.text;
                btn.onclick = () => handleAnswer(question, option);
                answerGroup.appendChild(btn);
            });

            container.appendChild(answerGroup);

            // Add options container if exists
            if (currentQuestion.optionsContainer) {
                const optionsSection = document.createElement('div');
                optionsSection.appendChild(currentQuestion.optionsContainer);
                container.appendChild(optionsSection);
            }
        }

       
        // ADD THIS NEW FUNCTION
        function handleTextAnswer(question) {
            const input = document.getElementById('text-answer-input');
            const textValue = input.value.trim();

            if (!textValue) {
                alert('Please enter an answer before submitting.');
                return;
            }

            // Store the answer (no score for text questions)
            auditData.answers[question.id] = {
                score: null, 
                value: textValue,
                text: textValue,
                comment: "",
                image_data: "",
                selected_options: []
            };

            addMessage(textValue, 'user');

            // Add follow-up questions if configured
            if (question.allow_image_upload) {
                followUpQueue.push({ type: 'image', forQuestionId: question.id });
            }
            followUpQueue.push({ type: 'comment', forQuestionId: question.id });

            // Clear options and continue
            document.getElementById('answer-options').innerHTML = '';
            setTimeout(processNextInQueue, 500);
        }
        function handleAnswer(question, answer) {
            // Store answer
            auditData.answers[question.id] = {
                score: answer.score,
                value: answer.value,
                text: answer.text,
                comment: "",
                image_data: "",
                selected_options: []
            };

            // Get selected options if any
            if (currentQuestion.optionsContainer) {
                const selectedOptions = Array.from(
                    currentQuestion.optionsContainer.querySelectorAll('input:checked')
                ).map(cb => cb.value);
                
                if (selectedOptions.length > 0) {
                    auditData.answers[question.id].selected_options = selectedOptions;
                    addMessage(`Selected: ${selectedOptions.join(', ')}`, 'user');
                }
            }

            addMessage(answer.text, 'user');

            // Add follow-up questions
            if (question.allow_image_upload) {
                followUpQueue.push({ type: 'image', forQuestionId: question.id });
            }
            followUpQueue.push({ type: 'comment', forQuestionId: question.id });

            // Clear options and continue
            document.getElementById('answer-options').innerHTML = '';
            setTimeout(processNextInQueue, 500);
        }

        function askFollowUpQuestion(followUp) {
            const questionText = followUp.type === 'image' 
                ? "üì∑ Would you like to add a photo for this question?"
                : "üí¨ Any additional comments or notes?";
            
            addMessage(questionText, "bot");
            
            const container = document.getElementById('answer-options');
            container.innerHTML = '';

            const followUpContainer = document.createElement('div');
            followUpContainer.className = 'follow-up-container';

            if (followUp.type === 'image') {
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = 'image/*';
                fileInput.className = 'file-input';
                fileInput.onchange = (e) => handleImageFollowUp(followUp, e.target.files[0]);
                followUpContainer.appendChild(fileInput);
            } else {
                const textarea = document.createElement('textarea');
                textarea.className = 'follow-up-textarea';
                textarea.placeholder = 'Enter your comments here...';
                followUpContainer.appendChild(textarea);

                const actionsContainer = document.createElement('div');
                actionsContainer.className = 'follow-up-actions';

                const submitBtn = document.createElement('button');
                submitBtn.className = 'answer-btn';
                submitBtn.textContent = 'Submit Comment';
                submitBtn.onclick = () => handleCommentFollowUp(followUp, textarea.value);
                actionsContainer.appendChild(submitBtn);

                const skipBtn = document.createElement('button');
                skipBtn.className = 'answer-btn skip-btn';
                skipBtn.textContent = 'Skip';
                skipBtn.onclick = () => {
                    container.innerHTML = '';
                    processNextInQueue();
                };
                actionsContainer.appendChild(skipBtn);

                followUpContainer.appendChild(actionsContainer);
            }

            if (followUp.type === 'image') {
                const skipBtn = document.createElement('button');
                skipBtn.className = 'answer-btn skip-btn';
                skipBtn.textContent = 'Skip Photo';
                skipBtn.onclick = () => {
                    container.innerHTML = '';
                    processNextInQueue();
                };
                followUpContainer.appendChild(skipBtn);
            }

            container.appendChild(followUpContainer);
        }

        async function handleImageFollowUp(followUp, file) {
            if (!file) {
                document.getElementById('answer-options').innerHTML = '';
                processNextInQueue();
                return;
            }

            try {
                const base64 = await toBase64(file);
                auditData.answers[followUp.forQuestionId].image_data = base64;
                addMessage("üì∑ Image attached successfully", 'user');
            } catch (error) {
                console.error('Error processing image:', error);
                addMessage("‚ùå Failed to attach image", 'user');
            }

            document.getElementById('answer-options').innerHTML = '';
            setTimeout(processNextInQueue, 500);
        }

        function handleCommentFollowUp(followUp, comment) {
            if (comment && comment.trim()) {
                auditData.answers[followUp.forQuestionId].comment = comment.trim();
                addMessage(comment, 'user');
            }

            document.getElementById('answer-options').innerHTML = '';
            setTimeout(processNextInQueue, 500);
        }

        // Submit Audit
        async function submitAudit() {
            const submitBtn = document.getElementById('submit-btn');
            const originalText = submitBtn.textContent;
            
            submitBtn.textContent = 'Submitting...';
            submitBtn.disabled = true;

            try {
                // Format answers for submission
                const formattedAnswers = Object.entries(auditData.answers).map(([questionId, answer]) => ({
                    question_id: questionId,
                    answer_value: answer.value,
                    answer_comment: answer.comment || '',
                    image_data: answer.image_data || '',
                    selected_options: answer.selected_options || [],
                    category: auditData.categories.find(cat => 
                        cat.questions.some(q => q.id === questionId)
                    )?.id
                }));

                const response = await fetch('/api/method/restaurant_audit.api.audit_api.submit_audit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        restaurant_id: currentRestaurant.name,
                        answers: JSON.stringify(formattedAnswers),
                        overall_comment: document.getElementById('overall-comment').value || ''
                    })
                });

                if (!response.ok) {
                    throw new Error(`Submit failed with status: ${response.status}`);
                }

                const result = await response.json();
                if (!result.message?.success) {
                    throw new Error(result.message?.message || 'Failed to submit audit');
                }

                // Clear saved progress
                localStorage.removeItem(`audit_progress_${currentRestaurant.name}`);

                // Show success and redirect
                showNotification('Audit submitted successfully! üéâ', 'success');
                setTimeout(() => {
                    window.location.href = '/audit-restaurants';
                }, 2000);

            } catch (error) {
                console.error('Submit error:', error);
                showNotification(`Error: ${error.message}`, 'error');
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        }

        // Utility Functions
        function addMessage(text, sender, id = null) {
            const messagesContainer = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message slide-up`;
            if (id) messageDiv.id = id;
            messageDiv.innerHTML = text;
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function showTypingIndicator() {
            const messagesContainer = document.getElementById('chat-messages');
            const indicator = document.createElement('div');
            indicator.className = 'typing-indicator';
            indicator.innerHTML = '<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>';
            messagesContainer.appendChild(indicator);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            return indicator;
        }

        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.textContent = message;
            
            // Style the notification
            Object.assign(notification.style, {
                position: 'fixed',
                top: '20px',
                right: '20px',
                padding: '1rem 1.5rem',
                borderRadius: '8px',
                color: 'white',
                fontWeight: '600',
                zIndex: '9999',
                transform: 'translateX(100%)',
                transition: 'transform 0.3s ease'
            });

            // Set background color based on type
            const colors = {
                success: 'var(--success-color)',
                error: 'var(--error-color)',
                warning: 'var(--warning-color)',
                info: 'var(--primary-color)'
            }
        }

        function showError(message) {
    console.error("‚ùå Error:", message);

    const errorDiv = document.getElementById('error');
    if (errorDiv) {
        errorDiv.style.display = 'block';
        errorDiv.textContent = message;
    }

    const loadingDiv = document.getElementById('loading');
    if (loadingDiv) {
        loadingDiv.style.display = 'none';
    }
}
function toBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
    });
}


function goBack() {
            window.history.back();
        }

       

 </script>
        </body>
</html>